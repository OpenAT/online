<?xml version="1.0" encoding="utf-8"?>
<openerp>
    <data noupdate="0">

        <!-- Load custom js and css -->
        <template id="assets_frontend" inherit_id="website.assets_frontend" name="fso_forms_assets_frontend">
            <xpath expr="//script[last()]" position="after">
                <!-- CSS -->
                <link rel="stylesheet" href='/fso_forms/static/src/css/fso_forms.css'/>
                <!-- JAVA SCRIPT -->
                <script type="text/javascript" src="/fso_forms/static/src/js/fso_forms.js"/>
            </xpath>
        </template>


        <!-- Website Template: form -->
        <!-- TODO: Change all 'apf_' classes to 'fsoforms_' and update fso_forms.css -->
        <template id="form" name="FSON Forms Website Template" page="True">
            <t t-call="website.layout">
                <t t-set="title"><t t-esc="form.name"/></t>
                <div id="wrap" t-att-class="'fso_form_wrap fso_form_wrap_'+str(form.id)">
                    <div class="container apf_container">

                        <!-- TOP SNIPPETS ON FORM PAGE -->
                        <div class="row">
                            <div class="col-lg-12">
                                <div t-field="form.snippet_area_top" class="oe_structure apf_top_snippets"/>
                            </div>
                        </div>
                        
                        <!-- FORM action="/fso/form/submit" -->
                        <div class="row fso_form_row">
                            <div class="col-lg-12 fso_form_column">
                                <form id="fso_form"
                                      t-att-class="'fso_form_validate' if form.frontend_validation else ''"
                                      t-att-action="'/fso/form/'+str(form.id)"
                                      method="post"
                                      enctype="multipart/form-data"
                                      autocomplete="off">
                                    
                                    <!-- FORM FIELDS LOOP -->
                                    <t t-foreach="form.field_ids" t-as="field">
                                        <t t-if="field.show">
                                            <!-- Get field css classes -->
                                            <t t-set="css_classes" t-value="field.css_classes"/>
                                            
                                            <!-- SNIPPET AREA FIELD -->
                                            <t t-if="not field.field_id">
                                                <div t-att-class="css_classes if css_classes else 'col-lg-12'">
                                                    <div t-field="field.information" class="oe_structure apf_field_snippet"/>
                                                    <t t-if="field.clearfix">
                                                        <div class="clearfix"/>
                                                    </t>
                                                </div>
                                            </t>
                                            
                                            <!-- REGULAR FIELD -->
                                            <t t-if="field.field_id">
                                                
                                                <!-- Get Regular Field Info -->
                                                <t t-set="f_name" t-value="field.field_id.name"/>
                                                <t t-set="f_type" t-value="field.field_id.ttype"/>
                                                <t t-set="validation_rule" t-value="{}"/>
                                                <t t-if="field.validation_rule">
                                                    <t t-set="validation_rule" t-value="dict(item.split('=') for item in field.validation_rule.split(';'))"/>
                                                </t>
                                                
                                                <!-- !!! LIMIT FIELD TYPES !!! -->
                                                <!-- TODO: Add an api constrain in the model that restrict other field types -->
                                                <t t-if="f_type in ('boolean', 'char', 'selection', 'date', 'integer', 'float', 'binary')">
                                                    
                                                    <!-- form group -->
                                                    <div t-att-class="'form-group has-feedback ' + css_classes + ' f-type-' + f_type + ((' has-error ' + form_field_errors.get(f_name)) if form_field_errors.get(f_name) else '')">
                                                        
                                                        <!-- LABELS (AND BOOLEAN FIELDS) -->
                                                        <label t-att-class="'control-label f-' + f_name + (' mandatory text-danger' if field.mandatory else '')"
                                                               t-att-for="f_name">
                                                            
                                                            <!-- BOOLEAN FIELDS -->
                                                            <t t-if="f_type == 'boolean'">
                                                                <input type="checkbox"
                                                                       t-att-id="f_name"
                                                                       t-att-name="f_name"
                                                                       t-att-value="kwargs.get(f_name) if field.nodata else record[f_name]"
                                                                       t-att-checked="True if record[f_name] else ''"
                                                                       t-att-required="field.mandatory"/>
                                                            </t>
                                                            
                                                            <t t-raw="field.label"/>
                                                        </label>
                                                        
                                                        <!-- MODAL BOX -->
                                                        <t t-if="field.information">
                                                            <!-- Modal Box Button-Link -->
                                                            <href type="button"
                                                                    class="btn-link information-modal-box-trigger"
                                                                    data-toggle="modal"
                                                                    t-att-data-target="'#information-'+f_name">
                                                                <span class="glyphicon glyphicon-info-sign"/>
                                                            </href>
                                                            <!-- Modal Box -->
                                                            <div class="modal fade"
                                                                 t-att-id="'information-'+f_name"
                                                                 role="dialog">
                                                                <div class="modal-dialog">
                                                                    <!-- Modal content-->
                                                                    <div class="modal-content">
                                                                        <div class="modal-header">
                                                                            <button type="button" class="close"
                                                                                    data-dismiss="modal">&amp;times;</button>
                                                                            <h4 class="modal-title">
                                                                                <t t-raw="field.label"/>
                                                                            </h4>
                                                                        </div>
                                                                        <div class="modal-body">
                                                                            <t t-raw="field.information"/>
                                                                        </div>
                                                                        <div class="modal-footer">
                                                                            <button type="button" class="btn btn-default" data-dismiss="modal">
                                                                                Close
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </t>

                                                        <!-- CHAR FIELDS -->
                                                        <t t-if="f_type in ['char',]">
                                                            <input type="text"
                                                                   t-att-id="f_name"
                                                                   t-att-name="f_name"
                                                                   class="form-control"
                                                                   t-att-value="kwargs.get(f_name) if field.nodata else record[f_name]"
                                                                   t-att-placeholder="field.placeholder"
                                                                   t-att-required="field.mandatory"
                                                                   t-att="validation_rule"
                                                            />
                                                        </t>

                                                        <!-- DATE FIELDS -->
                                                        <t t-if="f_type in ['date',]">
                                                            <t t-set="date_de_value" t-value="record[f_name]"/>
                                                            <t t-set="date_de"
                                                               t-value="datetime.datetime.strftime(datetime.datetime.strptime(date_de_value,'%Y-%m-%d'), '%d.%m.%Y') if date_de_value else None"
                                                            />
                                                            <input type="text"
                                                                   t-att-id="f_name"
                                                                   t-att-name="f_name"
                                                                   class="form-control"
                                                                   t-att-value="kwargs.get(f_name) if field.nodata else date_de"
                                                                   t-att-placeholder="field.placeholder"
                                                                   t-att-required="field.mandatory"
                                                                   t-att="validation_rule"
                                                            />
                                                        </t>
                                                        
                                                        <!-- INTEGER FIELDS -->
                                                        <!-- HINT: type=number is html5 but will work in most browser for html 4.01 -->
                                                        <t t-if="f_type in ['integer',]">
                                                            <input type="number"
                                                                   t-att-id="f_name"
                                                                   t-att-name="f_name"
                                                                   class="form-control"
                                                                   t-att-value="kwargs.get(f_name) if field.nodata else record[f_name]"
                                                                   t-att-placeholder="field.placeholder"
                                                                   t-att-required="field.mandatory"
                                                                   t-att="validation_rule"
                                                                   step="1"
                                                            />
                                                        </t>
                                                        
                                                        <!-- FLOAT FIELDS -->
                                                        <!-- HINT: type=number is html5 but will work in most browser for html 4.01 -->
                                                        <!-- TODO: Localization (right now forced to DE) check how it is done in website_sale -->
                                                        <t t-if="f_type in ['float',]">
                                                            <input type="text"
                                                                   t-att-id="f_name"
                                                                   t-att-name="f_name"
                                                                   class="form-control"
                                                                   t-att-value="kwargs.get(f_name) if field.nodata else str(record[f_name]).replace('.', ',')"
                                                                   t-att-placeholder="field.placeholder"
                                                                   t-att-required="field.mandatory"
                                                                   t-att="validation_rule"
                                                            />
                                                        </t>
                                                        
                                                        <!-- BINARY (FILE) FIELDS -->
                                                        <!-- TODO: Handle image previews -->
                                                        <!-- TODO: Handle mime and file types -->
                                                        <t t-if="f_type in ['binary',]">
                                                            <input type="file"
                                                                   t-att-id="f_name"
                                                                   t-att-name="f_name"
                                                                   class="input-file file form-control"
                                                                   t-att-required="field.mandatory"
                                                                   t-att="validation_rule"
                                                                   multiple="false"
                                                            />
                                                        </t>

                                                        <!-- SELECTION FIELDS -->
                                                        <!-- ATTENTION: This is not for relational fields like Many2* -->
                                                        <t t-if="f_type == 'selection'">

                                                            <!-- Selection List Style -->
                                                            <t t-if="field.style == 'selection' or not field.style">
                                                                <select t-att-id="f_name"
                                                                        t-att-name="f_name"
                                                                        class="form-control"
                                                                        t-att-required="field.mandatory">
                                                                    <!-- Default empty option -->
                                                                    <option value=""><t t-esc="field.placeholder"/></option>
                                                                    <!-- Selection Values as options -->
                                                                    <t t-foreach="request.env[form.model_id.model]._columns[f_name].selection or []" t-as="option">
                                                                        <!-- Create Option List -->
                                                                        <option t-att-value="option[0]"
                                                                                t-att-selected="True if (record[f_name] == option[0] and not field.nodata) or (kwargs.get(f_name) == str(option[0])) else None">
                                                                            <t t-esc="dict(request.env[form.model_id.model].fields_get([f_name])[f_name]['selection'])[option[0]]"/>
                                                                        </option>
                                                                    </t>
                                                                </select>
                                                            </t>

                                                            <!-- Radio Buttons Style -->
                                                            <t t-if="field.style in ('radio', 'radio_selectnone')">
                                                                <t t-if="field.style == 'radio_selectnone'">
                                                                    <div class="radio">
                                                                        <label>
                                                                            <input type="radio"
                                                                                   t-att-id="f_name + '_noselection'"
                                                                                   t-att-name="f_name"
                                                                                   value=""
                                                                                   t-att-checked="True if not record[f_name] and not kwargs.get(f_name) else None"
                                                                            />
                                                                            <t t-esc="field.placeholder or 'No Selection'"/>
                                                                        </label>
                                                                    </div>
                                                                </t>
                                                                <t t-foreach="request.env[form.model_id.model]._columns[f_name].selection or []" t-as="option">
                                                                    <div class="radio">
                                                                        <label>
                                                                            <input type="radio"
                                                                                   t-att-id="option[0]"
                                                                                   t-att-name="f_name"
                                                                                   t-att-value="option[0]"
                                                                                   t-att-checked="True if (record[f_name] == option[0] and not field.nodata) or (kwargs.get(f_name) == str(option[0])) else None"
                                                                            />
                                                                            <t t-esc="dict(request.env[form.model_id.model].fields_get([f_name])[f_name]['selection'])[option[0]]"/>
                                                                        </label>
                                                                    </div>
                                                                </t>
                                                            </t>
                                                        </t>
                                                        
                                                        <!-- TODO: Many2One -->
                                                        
                                                        <!-- TODO: One2Many and Many2Many  -->
                                                        
                                                    </div>
                                                </t>

                                                <!-- CLEARFIX DIV -->
                                                <t t-if="field.clearfix">
                                                    <div t-att-class="'clearfix clearfix-' + f_name"/>
                                                </t>
                                                
                                            </t>
                                        </t>
                                    </t>

                                    <!-- Submit Button -->
                                    <div class="row apf_submit">
                                        <div class="col-lg-12">
                                            <a id="apf_submit_button" class="btn btn-primary btn-lg a-submit">
                                                <span t-field="form.submit_button_text"/>
                                            </a>
                                        </div>
                                    </div>
                                    
                                </form>
                            </div>
                        </div>
                        
                        <!-- BOTTOM SNIPPETS ON FORM PAGE -->
                        <div class="row">
                            <div class="col-lg-12">
                                <div t-field="form.snippet_area_bottom" class="oe_structure apf_bottom_snippets"/>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </t>
        </template>
        
        
        <!-- SubTemplate: Message Display -->
        <template id="messages" name="Messages">
            <div t-att-id="msg_block_id" class="row apf_messages">
                <div class="col-lg-12">
                    <t t-foreach="err" t-as="error">
                        <div class="alert alert-danger" role="alert">
                            <t t-raw="error"/>
                        </div>
                    </t>
                    <t t-foreach="warn" t-as="warning">
                        <div class="alert alert-warning" role="alert">
                            <t t-raw="warning"/>
                        </div>
                    </t>
                    <t t-foreach="msg" t-as="message">
                        <div class="alert alert-success" role="alert">
                            <t t-raw="message"/>
                        </div>
                    </t>
                </div>
                <div class="clearfix"/>
            </div>
        </template>

        <!-- Template Option: Messages on Top -->
        <template id="fso_form_messages_top" inherit_id="fso_forms.form" name="Messages on Top"
                  customize_show="True" active="False">
            <xpath expr="//form" position="before">
                <t t-call="fso_forms.messages">
                    <t t-set="msg_block_id" t-value="'apf-data-msg-top'"/>
                    <t t-set="err" t-value="errors"/>
                    <t t-set="warn" t-value="warnings"/>
                    <t t-set="msg" t-value="messages"/>
                </t>
            </xpath>
        </template>
        
        <!-- Template Option: Messages on Bottom -->
        <template id="fso_form_messages_bottom" inherit_id="fso_forms.form" name="Messages on Bottom"
                  customize_show="True" active="True">
            <xpath expr="//form" position="after">
                <t t-call="fso_forms.messages">
                    <t t-set="msg_block_id" t-value="'apf-data-msg-bottom'"/>
                    <t t-set="err" t-value="errors"/>
                    <t t-set="warn" t-value="warnings"/>
                    <t t-set="msg" t-value="messages"/>
                </t>
            </xpath>
        </template>

    </data>
</openerp>
